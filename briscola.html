<!DOCTYPE html>
<html>
<head>

<style>
html {
    margin: 0 auto;
    max-width: 600px;
    background-color: honeydew;
}
#opponent_hand, #player_hand, #table {
    display: flex;
    align-items: center;
}
#table {
    height: 20em;
    justify-content: center;
}
.opponent_card {
    height: 16em;
    width: 7em;
    margin: 2em;
    border-radius: 1em;
    background-color: aliceblue;
    font-size: 2ex;
}
.card_down {
    height: 16em;
    width: 7em;
    margin: 1em;
    border-radius: 1em;
    background-color: linen;
    font-size: 2ex;
    visibility: hidden;
}
.last_card {
    height: 7em;
    width: 16em;
    margin: 2em;
    border-radius: 1em;
    background-color: linen;
    font-size: 2ex;
}
.player_card {
    height: 16em;
    width: 7em;
    margin: 2em;
    border-radius: 1em;
    background-color: linen;
    font-size: 2ex;
}
.player_card:hover {
    background-color: salmon;
}
</style>

<!-- Script section with common game utilities.
     The actual game loop is at the bottom of
     the page.
-->
<script>
"use strict";

function shuffle(array) {
  let currentIndex = array.length;

  // While there remain elements to shuffle...
  while (currentIndex != 0) {

    // Pick a remaining element...
    let randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
}

// Cards will be represented as a three-char string:
// "Value Suit" where
// Value: 1, 2, 3, 4, 5, 6, 7, F, C, R
// Suit: B C D S
// B has values [1..10]
// C has values [11..20]
// D has values [21..30]
// S has values [31..40]
function cardToNumber(text) {
    const ts = text.split(' ');
    let n = Number();
    switch(ts.at(0)) {
        case 'F':
            n = 8;
            break;
        case 'C':
            n = 9;
            break;
        case 'R':
            n = 10;
            break;
        default:
            n = Number(ts.at(0));
            break;
    }
    switch (ts.at(1)) {
        case 'B':
            break;
        case 'C':
            n += 10;
            break;
        case 'D':
            n += 20;
            break;
        case 'S':
            n += 30;
            break;
    }
    return n;
}

const value = (n) => ((n - 1) % 10) + 1;
const suit = (n) => Math.floor((n - 1) / 10);

// Returns the value in points of a number 1...10
// where 1 is the ace and 10 is the king.
const pvalue = {};
pvalue[1]  = 11;
pvalue[3]  = 10;
pvalue[10] = 4;
pvalue[9]  = 3;
pvalue[8]  = 2;
pvalue[7]  = 0;
pvalue[6]  = 0;
pvalue[5]  = 0;
pvalue[4]  = 0;
pvalue[2]  = 0;


// Returns the strength of a number 1...10
// where 1 is the ace and 10 is the king.
const svalue = {};
svalue[1]  = 10;
svalue[3]  = 9;
svalue[10] = 8;
svalue[9]  = 7;
svalue[8]  = 6;
svalue[7]  = 5;
svalue[6]  = 4;
svalue[5]  = 3;
svalue[4]  = 2;
svalue[2]  = 1;

function numberToCard(n) {
    const val = value(n);
    let s = String();
    if (val < 8) {
        s = String(val);
    } else if (val === 8) {
        s = 'F';
    } else if (val === 9) {
        s = 'C';
    } else if (val === 10) {
        s = 'R';
    }
    s += ' ';
    switch (suit(n)) {
        case 0:
            s += 'B';
            break;
        case 1:
            s += 'C';
            break;
        case 2:
            s += 'D';
            break;
        case 3:
            s += 'S';
            break;
    }
    return s;
}

// Computes the points assigned by the hand where the
// first player plays c1 and the second player plays c2.
// Returns the number of points won by the winning player,
// and the identity of the winning player (0 or 1).
function computeHand(c1, c2, trump_suit) {
    const v1 = value(c1);
    const v2 = value(c2);
    const s1 = suit(c1);
    const s2 = suit(c2);
    const pts = pvalue[v1] + pvalue[v2];
    // wins is 0 if player 1 wins, 1 if player 2 wins.
    let wins = 0;
    if (s1 === trump_suit) {
        if (s2 === trump_suit) {
            wins = Number(svalue[v1] < svalue[v2]);
        }
        // else player 1 wins.
    } else if (s2 === trump_suit) {
        // Player 2 wins
        wins = 1;
    } else if (s1 === s2) {
        wins = Number(svalue[v1] < svalue[v2]);
    } // else player 1 wins.
    return [pts, wins];
}

const sleep = (ms) => new Promise(res => setTimeout(res, ms));

class GameState {
    constructor() {
        // Deck is [1..40]
        this.deck = Array(40).fill().map((_, i) => i + 1);
        shuffle(this.deck);

        // Initial draw.
        this.hands[0] = [this.deck.pop(), this.deck.pop(), this.deck.pop()];
        this.hands[1] = [this.deck.pop(), this.deck.pop(), this.deck.pop()];
        this.trump_suit = suit(this.deck.at(0));
        // True if player 1 won last hand.
        this.won_last = true;
        this.points = [0, 0];
    }

    // Current cards in hand for players 1 and 2.
    hands = [[], []];

    drawCard() {
        return this.deck.pop();
    }
}

</script>

</head>
<body>

<div id=playing_desk>

<div id=opponent_hand>
<button class=opponent_card></button>
<button class=opponent_card></button>
<button class=opponent_card></button>
</div>

<div id=table>
<button class=card_down id=fst></button>
<button class=card_down id=snd></button>
<button class=last_card></button>
</div>

<div id=player_hand>
<button class=player_card></button>
<button class=player_card></button>
<button class=player_card></button>
</div>

</div>

<p id=points-count>Points: <span id=points-p1>0</span> <span id=points-p2>0</span></p>

<!-- Game logic starts here. -->
<script>
const player_cards = document.querySelectorAll(".player_card");
// First card played in this hand
const cd_fst = document.querySelector("#fst");
// Second card played in this hand
const cd_snd = document.querySelector("#snd");
// Slot to display points count.
const pts_p1 = document.querySelector("#points-p1");
const pts_p2 = document.querySelector("#points-p2");

const state = new GameState;

// Draw the initial hand.
window.onload = (event) => {
    i = 0;
    player_cards.forEach((card) => {
        card.textContent = numberToCard(state.hands[0].at(i));
        ++i;
    })
    // Paint last card.
    const last_card = document.querySelector(".last_card");
    last_card.textContent = numberToCard(state.deck.at(0));
};

// Takes as argument the card that was selected by the
// player.
async function playAsFirst(card) {
    const card_num = cardToNumber(card.textContent);
    cd_fst.textContent = card.textContent;
    cd_fst.style.visibility = "visible";
    card.style.visibility = "hidden";
    let card2_num = -1;
    let idx2 = -1;
    // Player 1 did just play a card. Now it's
    // Player 2's turn to play a card, which will
    // be chosen at random.
    idx2 = Math.floor(Math.random() * 3);
    card2_num = state.hands.at(1).at(idx2);
    await sleep(500);
    cd_snd.textContent = numberToCard(card2_num);
    cd_snd.style.visibility = "visible";
    // Compute who wins this hand.
    const [pts, winner] = computeHand(card_num, card2_num, state.trump_suit);
    // Update the points
    if (winner === 0) {
        state.points[0] += pts;
    } else {
        state.points[1] += pts;
    }
    // Draw the card at the top of the deck.
    const next_card = state.drawCard();
    const idx = state.hands.at(0).findIndex((c) => c === card_num);
    state.hands[0][idx] = next_card;
    card.textContent = numberToCard(next_card);
    // Wait a little and redraw
    await sleep(1500);
    cd_fst.style.visibility = "hidden";
    cd_snd.style.visibility = "hidden";
    card.style.visibility = "visible";
    // Update points counter
    pts_p1.textContent = state.points.at(0);
    pts_p2.textContent = state.points.at(1);
    // Update player 2's cards.
    state.hands[1][idx2] = state.drawCard();
    // If player 2 won, then it will play a random card
    // and wait for player 1's click.
    if (winner === 1) {
        // Player 2 plays a card chosen at random.
        idx2 = Math.floor(Math.random() * 3);
        card2_num = state.hands.at(1).at(idx2);
        // Update visibility
        await sleep(500);
        cd_fst.textContent = numberToCard(card2_num);
        cd_fst.style.visibility = "visible";
        // Update player 2's cards.
        state.hands[1][idx2] = state.drawCard();
        // Return, waiting for player 1's card.
    }
    // Update game state.
    state.won_last = winner === 0;
}


// Takes as argument the card that was selected by the
// player.
async function playAsSecond(card) {
    const card_num = cardToNumber(card.textContent);
    cd_snd.textContent = card.textContent;
    cd_snd.style.visibility = "visible";
    card.style.visibility = "hidden";
    await sleep(500);
    // Find what card was just played by player 2.
    card2_num = cardToNumber(cd_fst.textContent);
    // Compute who wins this hand.
    const [pts, winner] = computeHand(card2_num, card_num, state.trump_suit);
    // Update the points. Note that winner === 0 if player 2
    // won the hand, and winner === 1 if player 1 won.
    if (winner === 1) {
        state.points[0] += pts;
    } else {
        state.points[1] += pts;
    }
    // Draw the card at the top of the deck.
    const next_card = state.drawCard();
    const idx = state.hands.at(0).findIndex((c) => c === card_num);
    state.hands[0][idx] = next_card;
    card.textContent = numberToCard(next_card);
    // Wait a little and redraw
    await sleep(1500);
    cd_fst.style.visibility = "hidden";
    cd_snd.style.visibility = "hidden";
    card.style.visibility = "visible";
    // Update points counter
    pts_p1.textContent = state.points.at(0);
    pts_p2.textContent = state.points.at(1);
    // If player 2 won, then it will play a random card
    // and wait for player 1's click.
    if (winner === 0) {
        // Player 2 plays a card chosen at random.
        idx2 = Math.floor(Math.random() * 3);
        card2_num = state.hands.at(1).at(idx2);
        // Update visibility
        await sleep(500);
        cd_fst.textContent = numberToCard(card2_num);
        cd_fst.style.visibility = "visible";
        // Update player 2's cards.
        state.hands[1][idx2] = state.drawCard();
        // Return, waiting for player 1's card.
    }
    // Update game state.
    state.won_last = winner === 1;
}

// Bind functions to card click events.
player_cards.forEach((card) =>
    // Needs to be async to make the calls to sleep work.
    card.addEventListener("click", (event) => {
        if (state.won_last) {
            playAsFirst(card);
        } else {
            playAsSecond(card);
        }
    })
);
</script>

</body>
</html>
